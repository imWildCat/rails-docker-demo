upstream app_backend {
  server backend:3000 fail_timeout=0;
  keepalive 3;
}


server {
  listen 80 default_server;

  access_log /var/log/nginx/nginx-app-access.log;
  error_log  /var/log/nginx/nginx-app-error.log;

  # root /var/www/rails_app;
  root /rails_app_public;

  # No index.html because the index is from Rails
  # You may need this if your nginx will serve static files built directly from front-end build tools
  # index index.html;

    # Other static assets
  # For example, files or images generated by Hype (static promotional html files)
  # This block is defined here because it needs priority.
  # location /other-static/  {
  #      root /other_static;
  #      rewrite ^/other_static(.*)$ $1 break;
  #      index index.html;
  #      gzip_static on;
  #      expires     -1; # Disable cache for fast deployment
  #      add_header Cache-Control no-cache;
  #     #  log_not_found off;
  #      break;
  # }

  # location = / { # For root
  #    add_header Cache-Control no-cache;
  #    expires -1;
  #    try_files $uri $uri/ /index.html;
  # }

  location / {
    proxy_set_header        X-Forwarded-Proto https;
    proxy_set_header        Host              $http_host;
    proxy_set_header        X-Real-IP         $remote_addr;
    proxy_set_header        X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_redirect off;
    # post_action @ga;

    # If the file exists as a static file serve it directly without
    # running all the other rewrite tests on it
    if (-f $request_filename) {
      break;
    }

    if (!-f $request_filename) {
      proxy_pass http://app_backend;
      break;
    }
  }

  # Frontend assets
  location ~ ^/(js|css|img)/  {
      #  access_log off;
       gzip_static on;
       expires     max;
       add_header  Cache-Control public;
       log_not_found off;
       break;
  }

  # Rails assets
  location ~ ^/(assets|packs)/  {
       root /rails_app_public;
       gzip_static on;
       expires     30d;
       add_header  Cache-Control public;
       log_not_found off;
       break;
  }

  # location /static/ {
  #   expires 30d;
  #   access_log off;
  #   try_files tmp/static/$uri tmp/static/$uri/ tmp/static2/$uri tmp/static2/$uri/;
  # }

  client_max_body_size 32M;


}
